{% extends "base.html" %}

{% block content %}
<div class="header-row">
    <h1>Guest Database</h1>
    <div class="btn-group">
        <button type="button" class="btn" id="open-add-guest-btn"><span class="btn-label-short">+</span><span class="btn-label-full">+ Add New Guest</span></button>
        <button type="button" class="icon-btn" id="toggle-filters-btn" title="Filters">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
        </button>
        <div class="kebab-wrapper">
            <button type="button" class="icon-btn" id="page-menu-btn" aria-label="More">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
            </button>
            <div class="kebab-menu kebab-menu-right" id="page-menu">
                <div class="kebab-menu-search">
                    <input type="text" id="guest-search" placeholder="Search guests...">
                </div>
                <a href="{{ url_for('export_guests') }}">Export to Excel</a>
            </div>
        </div>
    </div>
</div>

{% if guests %}
<div class="table-controls" id="event-filters" style="display:none">
    <select class="filter-select" id="guest-gender-filter">
        <option value="">All Genders</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
    </select>
    <select class="filter-select" id="guest-sort">
        <option value="created-desc">Last Created</option>
        <option value="first-asc">First Name (A-Z)</option>
        <option value="last-asc">Last Name (A-Z)</option>
        <option value="gender-asc">Gender</option>
    </select>
</div>

<div class="table-scroll">
<table id="guests-table" class="sortable">
    <thead>
        <tr>
            <th data-sort="text">First Name</th>
            <th data-sort="text">Last Name</th>
            <th data-sort="text">Gender</th>
            <th data-sort="text" class="col-hide-mobile">Guest Notes</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for guest in guests %}
        <tr data-guest-id="{{ guest.id }}"
            data-gender="{{ guest.gender }}"
            data-first="{{ guest.first_name|lower }}"
            data-last="{{ (guest.last_name or '')|lower }}"
            data-created="{{ guest.date_created.isoformat() if guest.date_created else '' }}"
            data-is-me="{{ 'true' if guest.is_me else 'false' }}">
            <td class="inline-edit-cell"><input type="text" class="inline-edit ge-first" value="{{ guest.first_name }}" data-guest-id="{{ guest.id }}">{% if guest.is_me %}<span class="badge-me">Me</span>{% endif %}</td>
            <td><input type="text" class="inline-edit ge-last" value="{{ guest.last_name or '' }}" data-guest-id="{{ guest.id }}"></td>
            <td>
                <select class="inline-select ge-gender" data-guest-id="{{ guest.id }}">
                    <option value="Male"{{ ' selected' if guest.gender == 'Male' }}>Male</option>
                    <option value="Female"{{ ' selected' if guest.gender == 'Female' }}>Female</option>
                </select>
            </td>
            <td class="col-hide-mobile"><input type="text" class="inline-edit ge-notes" value="{{ guest.notes or '' }}" placeholder="Add notes about guest" data-guest-id="{{ guest.id }}"></td>
            <td>
                <div class="kebab-wrapper">
                    <button type="button" class="kebab-btn" aria-label="Actions">&#x2026;</button>
                    <div class="kebab-menu">
                        <button type="button" class="ge-is-me-btn" data-guest-id="{{ guest.id }}">{{ 'âœ“ This is me' if guest.is_me else 'This is me' }}</button>
                        <form method="POST" action="{{ url_for('delete_guest', guest_id=guest.id) }}" class="inline"
                              onsubmit="return confirm('Delete this guest? They will also be removed from all events.');">
                            <button type="submit" class="kebab-danger">Delete</button>
                        </form>
                    </div>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<p class="empty" id="no-results" style="display:none;">No guests match your filters.</p>
{% else %}
<p class="empty">No guests yet. Add your first guest!</p>
{% endif %}

<!-- Add New Guests modal (same as event page) -->
<div class="detail-overlay" id="add-guest-overlay" style="display:none">
    <div class="detail-card guest-db-card">
        <div class="detail-card-header">
            <span style="font-weight:600;font-size:1.05rem">Add New Guests</span>
            <button type="button" class="detail-close" id="add-guest-close">&times;</button>
        </div>
        <div class="add-guest-table-wrapper">
            <table class="add-guest-table" id="add-guest-table">
                <thead>
                    <tr>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Gender</th>
                        <th>Guest Notes</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="add-guest-tbody">
                </tbody>
            </table>
        </div>
        <div class="guest-db-footer">
            <button type="button" class="btn" id="add-guest-save-btn">Save</button>
        </div>
    </div>
</div>
{% endblock %}
