{% extends "base.html" %}

{% block content %}
{% set today = import('datetime').date.today() if false else none %}
<div class="header-row">
    <h1>List of Events</h1>
    <div class="btn-group">
        <a href="{{ url_for('add_event') }}" class="btn">+ New Event</a>
        <button type="button" class="icon-btn" id="toggle-filters-btn" title="Filters">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
        </button>
        <div class="kebab-wrapper">
            <button type="button" class="icon-btn" id="page-menu-btn" aria-label="More">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
            </button>
            <div class="kebab-menu kebab-menu-right" id="page-menu">
                <div class="kebab-menu-search">
                    <input type="text" id="event-search" placeholder="Search events...">
                </div>
                <a href="{{ url_for('export_events') }}">Excel</a>
            </div>
        </div>
    </div>
</div>

{% if events %}
<div class="table-controls" id="event-filters" style="display:none">
    <select class="filter-select" id="event-type-filter">
        <option value="">All Types</option>
        {% for t in event_types %}
        <option value="{{ t }}">{{ t }}</option>
        {% endfor %}
    </select>
    <select class="filter-select" id="event-sort">
        <option value="date-asc">Date (earliest first)</option>
        <option value="date-desc">Date (latest first)</option>
        <option value="created-desc">Recently created</option>
        <option value="name-asc">Name (A-Z)</option>
        <option value="name-desc">Name (Z-A)</option>
        <option value="guests-desc">Most guests</option>
        <option value="guests-asc">Fewest guests</option>
    </select>
</div>

<div class="event-list" id="event-grid">
    {% for event in events %}
    {% set attending = event.invitations|selectattr('status', 'equalto', 'Attending')|list|length %}
    {% set total = event.invitations|length %}
    <a href="{{ url_for('event_detail', event_id=event.id) }}" class="event-row-card"
       data-name="{{ event.name|lower }}"
       data-type="{{ event.event_type }}"
       data-date="{{ event.date.isoformat() }}"
       data-created="{{ event.date_created.isoformat() if event.date_created else '' }}"
       data-location="{{ (event.location or '')|lower }}"
       data-guests="{{ total }}"
       data-past="{{ 'true' if event.date < today_date else 'false' }}">
        <div class="event-row-left">
            <span class="event-row-name">{{ event.name }}</span>
            {% if event.location %}
            <span class="event-row-location">{{ event.location }}</span>
            {% endif %}
        </div>
        <div class="event-row-right">
            <span class="badge badge-{{ event.event_type|lower }}">{{ event.event_type }}</span>
            <span class="event-row-date">{{ event.date.strftime('%b %d, %Y') }}</span>
        </div>
        <div class="event-row-stats">
            <span class="stat">{{ total }} invited</span>
            <span class="stat stat-attending">{{ attending }} attending</span>
        </div>
    </a>
    {% endfor %}
</div>

<div class="past-events-section" id="past-events-section" style="display:none">
    <div class="past-events-toggle" id="past-events-toggle">
        <span class="collapse-icon">â–¶</span>
        <span>Past Events</span>
        <span class="past-events-count" id="past-events-count"></span>
    </div>
    <div class="event-list" id="past-event-grid" style="display:none"></div>
</div>

<p class="empty" id="no-results" style="display:none;">No events match your filters.</p>
{% else %}
<p class="empty">No events yet. Create your first event!</p>
{% endif %}
{% endblock %}
