{% extends "base.html" %}

{% block content %}
{% set today = import('datetime').date.today() if false else none %}
<div class="header-row">
    <h1>All Events</h1>
    <div class="btn-group">
        <button type="button" class="btn" id="open-new-event-btn"><span class="btn-label-full">+ New Event</span><span class="btn-label-short">+</span></button>
        <button type="button" class="icon-btn" id="toggle-filters-btn" title="Filters">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
        </button>
        <div class="kebab-wrapper">
            <button type="button" class="icon-btn" id="page-menu-btn" aria-label="More">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
            </button>
            <div class="kebab-menu kebab-menu-right" id="page-menu">
                <div class="kebab-menu-search">
                    <input type="text" id="event-search" placeholder="Search events...">
                </div>
                <a href="{{ url_for('export_events') }}">Export to Excel</a>
            </div>
        </div>
    </div>
</div>

{% if events %}
<div class="table-controls" id="event-filters" style="display:none">
    <select class="filter-select" id="event-type-filter">
        <option value="">All Types</option>
        {% for t in event_types %}
        <option value="{{ t }}">{{ t }}</option>
        {% endfor %}
    </select>
    <select class="filter-select" id="event-sort">
        <option value="date-asc">Date (earliest first)</option>
        <option value="date-desc">Date (latest first)</option>
        <option value="created-desc">Recently created</option>
        <option value="name-asc">Name (A-Z)</option>
        <option value="name-desc">Name (Z-A)</option>
        <option value="guests-desc">Most guests</option>
        <option value="guests-asc">Fewest guests</option>
    </select>
</div>

<div class="event-list" id="event-grid">
    {% for event in events %}
    {% set attending = event.invitations|selectattr('status', 'equalto', 'Attending')|list|length %}
    {% set total = event.invitations|length %}
    <a href="{{ url_for('event_detail', event_id=event.id) }}" class="event-row-card"
       data-name="{{ event.name|lower }}"
       data-type="{{ event.event_type }}"
       data-date="{{ event.date.isoformat() }}"
       data-created="{{ event.date_created.isoformat() if event.date_created else '' }}"
       data-location="{{ (event.location or '')|lower }}"
       data-guests="{{ total }}"
       data-past="{{ 'true' if event.date < today_date else 'false' }}">
        <div class="event-row-left">
            <span class="event-row-name">{{ event.name }}</span>
            {% if event.location %}
            <span class="event-row-location">{{ event.location }}</span>
            {% endif %}
        </div>
        <div class="event-row-right">
            <span class="badge badge-{{ event.event_type|lower }}">{{ event.event_type }}</span>
            <span class="event-row-date">{{ event.date.strftime('%b %d, %Y') }}</span>
        </div>
        <div class="event-row-stats">
            <span class="stat">{{ total }} invited</span>
            <span class="stat stat-attending">{{ attending }} attending</span>
        </div>
        {% if event.target_attendees %}
        <div class="event-row-progress">
            <div class="progress-bar-mini">
                <div class="progress-bar-mini-fill{% if attending > event.target_attendees %} over-target{% endif %}" style="width: {{ [((attending / event.target_attendees) * 100)|round|int, 100]|min }}%"></div>
            </div>
            <span class="progress-bar-mini-value{% if attending > event.target_attendees %} over-target{% elif attending == event.target_attendees %} at-target{% endif %}">{% if attending > event.target_attendees %}⚠ {% elif attending == event.target_attendees %}✓ {% endif %}{{ attending }}/{{ event.target_attendees }}</span>
        </div>
        {% endif %}
    </a>
    {% endfor %}
</div>

<div class="past-events-section" id="past-events-section" style="display:none">
    <div class="past-events-toggle" id="past-events-toggle">
        <span class="collapse-icon">▶</span>
        <span>Past Events</span>
        <span class="past-events-count" id="past-events-count"></span>
    </div>
    <div class="event-list" id="past-event-grid" style="display:none"></div>
</div>

<p class="empty" id="no-results" style="display:none;">No events match your filters.</p>
{% else %}
<p class="empty">No events yet. Create your first event!</p>
{% endif %}
<!-- New Event modal -->
<div class="detail-overlay" id="new-event-overlay" style="display:none">
    <div class="detail-card">
        <div class="detail-card-header">
            <span style="font-weight:600;font-size:1.05rem">New Event</span>
            <button type="button" class="detail-close" id="new-event-close">&times;</button>
        </div>
        <div class="detail-card-body">
            <form method="POST" action="{{ url_for('add_event') }}" class="form modal-form" id="new-event-form">
                <div class="form-row">
                    <div class="form-field">
                        <label for="ne-name">Event Name</label>
                        <input type="text" id="ne-name" name="name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="ne-location">Location</label>
                        <input type="text" id="ne-location" name="location" placeholder="Optional">
                    </div>
                    <div class="form-field">
                        <label for="ne-date">Date</label>
                        <input type="date" id="ne-date" name="date" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="ne-type">Type</label>
                        <select id="ne-type" name="event_type" required>
                            <option value="" disabled selected>Select type</option>
                            {% for t in event_types %}
                            <option value="{{ t }}">{{ t }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="ne-target">Target Attendees</label>
                        <input type="number" id="ne-target" name="target_attendees" placeholder="Optional" min="1">
                    </div>
                    {% if me_exists %}
                    <div class="form-field form-field-checkbox">
                        <label>&nbsp;</label>
                        <div class="checkbox-row">
                            <input type="checkbox" id="ne-include-me" name="include_me" checked>
                            <label for="ne-include-me">Include me as a guest</label>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="ne-notes">Notes</label>
                        <textarea id="ne-notes" name="notes" rows="3" placeholder="Optional"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn">Create Event</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
