{% extends "base.html" %}

{% block content %}
<div class="header-row">
    <h1>{{ event.name }}</h1>
</div>

<!-- Event info card -->
<div class="event-info-card">
    <div class="event-info-card-top">
        <div class="event-info-left">
            <span class="badge badge-{{ event.event_type|lower }}">{{ event.event_type }}</span>
        </div>
        <div class="kebab-wrapper">
            <button type="button" class="kebab-btn" aria-label="Actions">&#x2026;</button>
            <div class="kebab-menu kebab-menu-right">
                <a href="{{ url_for('edit_event', event_id=event.id) }}">Edit Event</a>
                <a href="{{ url_for('export_event_guests', event_id=event.id) }}">Export to Excel</a>
                <form method="POST" action="{{ url_for('delete_event', event_id=event.id) }}" class="inline"
                      onsubmit="return confirm('Delete this event and all its invitations?');">
                    <button type="submit" class="kebab-danger">Delete Event</button>
                </form>
            </div>
        </div>
    </div>
    <div class="event-info-details">
        <div class="event-info-row">
            <span class="event-info-label">Event Date</span>
            <span class="event-info-value">{{ event.date.strftime('%B %d, %Y') }}</span>
        </div>
        {% if event.location %}
        <div class="event-info-row">
            <span class="event-info-label">Location</span>
            <span class="event-info-value">{{ event.location }}</span>
        </div>
        {% endif %}
        {% if event.date_created %}
        <div class="event-info-row">
            <span class="event-info-label">Date Created</span>
            <span class="event-info-value">{{ event.date_created.strftime('%B %d, %Y') }}</span>
        </div>
        {% endif %}
    </div>
</div>

<!-- Attendance Summary (always shown) -->
{% set all_inv = event.invitations %}
{% set male_inv = all_inv|selectattr('guest.gender', 'equalto', 'Male')|list %}
{% set female_inv = all_inv|selectattr('guest.gender', 'equalto', 'Female')|list %}
<div class="collapsible">
    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <span class="collapse-icon">▼</span>
        <span class="summary-label">Attendance Summary</span>
    </div>
    <div class="collapsible-body">
        <table class="summary-table" id="summary-table">
            <thead>
                <tr>
                    <th></th>
                    <th>Attending</th>
                    <th>Pending</th>
                    <th>Declined</th>
                    <th class="summary-highlight">Total Invited</th>
                    <th>Not Yet Invited</th>
                </tr>
            </thead>
            <tbody>
                <tr data-gender="male">
                    <td class="row-label">Male</td>
                    <td data-stat="attending">{{ male_inv|selectattr('status', 'equalto', 'Attending')|list|length }}</td>
                    <td data-stat="pending">{{ male_inv|selectattr('status', 'equalto', 'Pending')|list|length }}</td>
                    <td data-stat="declined">{{ male_inv|selectattr('status', 'equalto', 'Declined')|list|length }}</td>
                    <td data-stat="invited" class="summary-highlight">{{ male_inv|rejectattr('status', 'equalto', 'Not Sent')|list|length }}</td>
                    <td data-stat="notsent">{{ male_inv|selectattr('status', 'equalto', 'Not Sent')|list|length }}</td>
                </tr>
                <tr data-gender="female">
                    <td class="row-label">Female</td>
                    <td data-stat="attending">{{ female_inv|selectattr('status', 'equalto', 'Attending')|list|length }}</td>
                    <td data-stat="pending">{{ female_inv|selectattr('status', 'equalto', 'Pending')|list|length }}</td>
                    <td data-stat="declined">{{ female_inv|selectattr('status', 'equalto', 'Declined')|list|length }}</td>
                    <td data-stat="invited" class="summary-highlight">{{ female_inv|rejectattr('status', 'equalto', 'Not Sent')|list|length }}</td>
                    <td data-stat="notsent">{{ female_inv|selectattr('status', 'equalto', 'Not Sent')|list|length }}</td>
                </tr>
                <tr class="total-row" data-gender="total">
                    <td class="row-label">Total</td>
                    <td data-stat="attending"><strong>{{ all_inv|selectattr('status', 'equalto', 'Attending')|list|length }}</strong></td>
                    <td data-stat="pending"><strong>{{ all_inv|selectattr('status', 'equalto', 'Pending')|list|length }}</strong></td>
                    <td data-stat="declined"><strong>{{ all_inv|selectattr('status', 'equalto', 'Declined')|list|length }}</strong></td>
                    <td data-stat="invited" class="summary-highlight"><strong>{{ all_inv|rejectattr('status', 'equalto', 'Not Sent')|list|length }}</strong></td>
                    <td data-stat="notsent"><strong>{{ all_inv|selectattr('status', 'equalto', 'Not Sent')|list|length }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Guest List -->
<div class="collapsible section">
    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <span class="collapse-icon">▼</span>
        <h2 style="margin-bottom:0">Guest List</h2>
    </div>
    <div class="collapsible-body">
        <div class="guest-list-controls">
            <input type="text" class="search-input" data-table="invitations-table" placeholder="Search guests...">
            <button type="button" class="icon-btn" id="gl-toggle-filters-btn" title="Filters">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
            </button>
            <div class="kebab-wrapper">
                <button type="button" class="icon-btn gl-menu-btn" aria-label="More">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
                </button>
                <div class="kebab-menu kebab-menu-right">
                    <a href="{{ url_for('export_event_guests', event_id=event.id) }}">Export to Excel</a>
                    <button type="button" id="toggle-multiselect-btn">Multi-Select</button>
                </div>
            </div>
        </div>

        <div class="table-controls" id="gl-filters" style="display:none">
            <select class="filter-select" data-table="invitations-table" data-col="4">
                <option value="">All Statuses</option>
                <option value="Not Sent">Not Sent</option>
                <option value="Pending">Pending</option>
                <option value="Attending">Attending</option>
                <option value="Declined">Declined</option>
            </select>
            <select class="filter-select" data-table="invitations-table" data-col="2">
                <option value="">All Genders</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
        </div>

        <div class="batch-bar" id="batch-bar" style="display:none">
            <span id="batch-count">0</span> selected
            <select id="batch-action" class="inline-select">
                <option value="">Apply action...</option>
                <option value="send">Mark as Sent</option>
                <option value="unsend">Mark as Not Sent</option>
                <option value="attending">Set Attending</option>
                <option value="pending">Set Pending</option>
                <option value="declined">Set Declined</option>
            </select>
            <button type="button" class="btn btn-small" id="batch-apply">Apply</button>
            <button type="button" class="btn btn-small btn-secondary" id="batch-clear">Clear</button>
        </div>

        <div class="guest-list-actions">
            <button type="button" class="btn btn-secondary" id="add-from-db-btn">+ Add from Guest Database</button>
        </div>

        <div class="table-scroll">
        <table id="invitations-table" class="sortable">
            <thead>
                <tr>
                    <th class="center col-check col-multiselect" style="display:none"><input type="checkbox" id="select-all"></th>
                    <th data-sort="text">Guest</th>
                    <th data-sort="text" class="col-hide-mobile">Gender</th>
                    <th class="center">Sent</th>
                    <th data-sort="text">Status</th>
                    <th class="col-hide-mobile">Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for inv in event.invitations %}
                <tr data-inv-id="{{ inv.id }}" data-guest-id="{{ inv.guest.id }}"
                    data-channel="{{ inv.channel or '' }}"
                    data-sent="{{ 'true' if inv.status != 'Not Sent' else 'false' }}"
                    data-date-invited="{{ inv.date_invited.strftime('%b %d, %Y') if inv.date_invited else '' }}"
                    data-date-invited-iso="{{ inv.date_invited.isoformat() if inv.date_invited else '' }}"
                    data-date-responded="{{ inv.date_responded.strftime('%b %d, %Y') if inv.date_responded else '' }}"
                    data-date-responded-iso="{{ inv.date_responded.isoformat() if inv.date_responded else '' }}">
                    <td class="center col-multiselect" style="display:none"><input type="checkbox" class="row-select"></td>
                    <td class="guest-name-cell">{{ inv.guest.full_name }}</td>
                    <td class="col-hide-mobile">{{ inv.guest.gender }}</td>
                    <td class="center">
                        <input type="checkbox" class="sent-checkbox"
                               data-inv-id="{{ inv.id }}"
                               {{ 'checked' if inv.status != 'Not Sent' }}>
                    </td>
                    <td>
                        {% if inv.status == 'Not Sent' %}
                        <span class="status-not-sent">Not Sent</span>
                        {% else %}
                        <select class="inline-select status-select" data-inv-id="{{ inv.id }}">
                            <option value="Pending" {{ 'selected' if inv.status == 'Pending' }}>Pending</option>
                            <option value="Attending" {{ 'selected' if inv.status == 'Attending' }}>Attending</option>
                            <option value="Declined" {{ 'selected' if inv.status == 'Declined' }}>Declined</option>
                        </select>
                        {% endif %}
                    </td>
                    <td class="col-hide-mobile">
                        <input type="text" class="inv-notes-input" data-inv-id="{{ inv.id }}"
                               value="{{ inv.notes or '' }}" placeholder="Add note...">
                    </td>
                    <td>
                        <div class="kebab-wrapper">
                            <button type="button" class="kebab-btn" aria-label="Actions">&#x2026;</button>
                            <div class="kebab-menu">
                                <button type="button" class="edit-btn">Edit</button>
                                <button type="button" class="kebab-danger remove-btn" data-inv-id="{{ inv.id }}">Remove</button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                <tr class="add-guest-row" data-event-id="{{ event.id }}" data-channels="{{ channels|join(',') }}">
                    <td class="col-multiselect" style="display:none"></td>
                    <td colspan="2">
                        <div class="autocomplete-wrapper">
                            <div class="inline-name-inputs">
                                <input type="text" class="inline-input" id="add-first-name" placeholder="First name">
                                <input type="text" class="inline-input" id="add-last-name" placeholder="Last name">
                            </div>
                            <div class="autocomplete-dropdown" id="autocomplete-dropdown"></div>
                        </div>
                    </td>
                    <td></td>
                    <td>
                        <select class="inline-select" id="add-status">
                            <option value="Not Sent">Not Sent</option>
                            <option value="Pending">Pending</option>
                            <option value="Attending">Attending</option>
                            <option value="Declined">Declined</option>
                        </select>
                    </td>
                    <td class="col-hide-mobile">
                        <select class="inline-select" id="add-gender">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </td>
                    <td>
                        <button type="button" class="btn btn-small" id="add-guest-btn">+ Add</button>
                    </td>
                </tr>
            </tbody>
        </table>
        </div>
    </div>
</div>

<!-- Notes -->
<div class="collapsible section">
    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <span class="collapse-icon">▼</span>
        <h2 style="margin-bottom:0">Notes</h2>
    </div>
    <div class="collapsible-body">
        <textarea id="event-notes" class="event-notes-textarea"
                  data-event-id="{{ event.id }}" placeholder="Add event notes...">{{ event.notes or '' }}</textarea>
        <span class="save-indicator" id="notes-save-indicator">Saved</span>
    </div>
</div>

<!-- Guest Database Picker Modal -->
<div class="detail-overlay" id="guest-db-overlay" style="display:none">
    <div class="detail-card guest-db-card">
        <div class="detail-card-header">
            <span style="font-weight:600;font-size:1.05rem">Add from Guest Database</span>
            <button type="button" class="detail-close" id="guest-db-close">&times;</button>
        </div>
        <div class="guest-db-search">
            <input type="text" id="guest-db-search-input" placeholder="Search guests...">
        </div>
        <div class="guest-db-list" id="guest-db-list"></div>
        <div class="guest-db-footer">
            <button type="button" class="btn" id="guest-db-add-btn">Add Selected</button>
        </div>
    </div>
</div>

<!-- Detail / Edit card modal -->
<div class="detail-overlay" id="detail-overlay" style="display:none">
    <div class="detail-card">
        <div class="detail-card-header">
            <div class="detail-name-form">
                <input type="text" class="detail-name-input" id="detail-first-name" placeholder="First name">
                <input type="text" class="detail-name-input" id="detail-last-name" placeholder="Last name">
            </div>
            <button type="button" class="detail-close" id="detail-close">&times;</button>
        </div>
        <div class="detail-card-body">
            <div class="detail-row">
                <span class="detail-label">Gender</span>
                <select id="detail-gender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="detail-row">
                <span class="detail-label">Sent</span>
                <label class="ios-toggle">
                    <input type="checkbox" id="detail-sent-toggle">
                    <span class="ios-toggle-slider"></span>
                </label>
            </div>
            <div class="detail-row">
                <span class="detail-label">Channel</span>
                <select id="detail-channel">
                    <option value="">--</option>
                    {% for ch in channels %}
                    <option value="{{ ch }}">{{ ch }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="detail-row">
                <span class="detail-label">Invited On</span>
                <span id="detail-date-invited" class="detail-value"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status</span>
                <select id="detail-status">
                    <option value="Pending">Pending</option>
                    <option value="Attending">Attending</option>
                    <option value="Declined">Declined</option>
                </select>
            </div>
            <div class="detail-row">
                <span class="detail-label">Responded On</span>
                <span id="detail-date-responded" class="detail-value"></span>
            </div>
            <div class="detail-row detail-row-full">
                <span class="detail-label">Notes</span>
                <textarea id="detail-notes" placeholder="Add note..."></textarea>
            </div>
        </div>
    </div>
</div>
{% endblock %}
